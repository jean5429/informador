<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Painel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca de Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonte Inter (Moderna e Legível) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* Estilo base para a fonte e o loader */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-slate-900 */
            color: #e2e8f0; /* text-slate-200 */
            overflow: hidden; /* Impede a rolagem do body */
        }
        
        /* Estilo do Loader Padrão */
        .loader {
            border: 4px solid #334155; /* border-slate-700 */
            border-top: 4px solid #6366f1; /* border-indigo-500 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 3rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animação da Greatball */
        .greatball-spin {
            animation: spin 1s linear infinite;
        }

        /* Melhorando o foco do contenteditable */
        [contenteditable]:focus {
            outline: 2px solid #6366f1;
            border-radius: 4px;
            background-color: #1e293b; /* bg-slate-800 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        /* Ajuste para o scrollbar do painel lateral */
        .sidebar-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background-color: #334155; /* bg-slate-700 */
            border-radius: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background-color: transparent;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col lg:flex-row">

    <!-- Coluna Principal (Conteúdo) -->
    <div class="flex-1 flex flex-col p-8 md:p-12 lg:w-2/3 h-full">

        <!-- PEÇA PRINCIPAL: Eventos -->
        <main class="flex-1 flex flex-col min-h-0">
            <!-- Eventos (não crescem) -->
            <section class="flex-shrink-0">
                <div class="flex items-center gap-4 mb-6">
                    <i data-lucide="calendar-clock" class="text-green-400 w-10 h-10 flex-shrink-0"></i>
                    <h2 class="text-5xl font-bold">Eventos Pokémon</h2>
                </div>
                <!-- Detalhes dos eventos aumentados -->
                <div class="space-y-8">
                    <!-- Scarlet/Violet -->
                    <div class="bg-slate-800/50 backdrop-blur-md border border-slate-700/50 rounded-2xl p-6">
                        <h3 class="text-3xl font-medium text-purple-300">Scarlet & Violet</h3>
                        <p class="text-2xl text-gray-200 mt-2">Ranked Battles Season 35</p>
                        <p class="text-lg text-gray-400 mt-1">Termina: 31 de Outubro, 2025</p>
                    </div>
                    <!-- Legends ZA -->
                    <div class="bg-slate-800/50 backdrop-blur-md border border-slate-700/50 rounded-2xl p-6">
                        <h3 class="text-3xl font-medium text-blue-300">Legends Z-A</h3>
                        <p class="text-2xl text-gray-200 mt-2">Ranked Battles Season 1</p>
                        <p class="text-lg text-gray-400 mt-1">Termina: 04/Nov/2025, 9:59 p.m. PST</p>
                    </div>
                </div>
            </section>

            <!-- Container do Pokémon (cresce para preencher o espaço) -->
            <section id="pokemon-container" class="flex-1 flex flex-col justify-center items-center p-4 min-h-0">
                <!-- Loader Específico do Pokémon (Greatball) -->
                <div id="pokemon-loader">
                    <svg class="greatball-spin" xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke-width="1.5">
                        <path stroke="#f87171" fill="#f87171" d="M12 2a10 10 0 0 0-9.9 9h19.8A10 10 0 0 0 12 2Z"></path>
                        <path stroke="#e2e8f0" fill="#e2e8f0" d="M2.1 13h19.8A10 10 0 0 1 12 22a10 10 0 0 1-9.9-9Z"></path>
                        <path stroke="#0f172a" fill="#0f172a" stroke-linecap="round" stroke-linejoin="round" d="M2.1 13h19.8M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"></path>
                        <path stroke="#e2e8f0" fill="#e2e8f0" stroke-linecap="round" stroke-linejoin="round" d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path>
                    </svg>
                </div>
                <!-- Imagem será injetada aqui -->
                <img id="pokemon-image" src="" alt="Pokémon Aleatório" class="hidden opacity-0 transition-opacity duration-500 ease-in-out h-auto" style="max-height: 100%; max-width: 100%; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.5));">
            </section>
        </main>

        <!-- RODAPÉ: Widget de Clima -->
        <footer class="flex-shrink-0 mt-8">
            <!-- Widget de Clima Redesenhado -->
            <div class="bg-slate-800/50 backdrop-blur-md border border-slate-700/50 rounded-2xl p-6 shadow-lg">
                <div class="flex justify-between items-center">
                    <!-- Informações do Clima -->
                    <div id="weather-content" class="flex items-center gap-4">
                        <!-- Conteúdo do Clima será injetado aqui -->
                        <div class="loader !m-0"></div>
                        <p class="text-xl">Carregando clima...</p>
                    </div>
                    <!-- Localização -->
                    <div class="text-right">
                        <h2 class="text-2xl font-bold">Clima Atual</h2>
                        <div id="weather-location" class="text-lg text-gray-400">
                            Americana, SP
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Coluna da Barra Lateral (Feeds e Relógio) -->
    <aside class="lg:w-1/3 lg:h-full bg-slate-800/50 backdrop-blur-md border-l border-slate-700/50">
        <div class="p-8 md:p-10 space-y-8">
            
            <!-- Seção: Relógio, Data e Foco -->
            <section>
                <!-- Relógio -->
                <div id="clock" class="text-6xl font-bold text-indigo-400">
                    --:--
                </div>
                <!-- Data -->
                <div id="date" class="text-xl text-gray-300 font-light">
                    -- de ------ de ----
                </div>

                <!-- Saudação e Foco -->
                <div class="mt-4">
                    <h1 class="text-2xl font-bold" id="greeting"></h1>
                    <p class="text-base text-gray-400 mt-1">Seu foco para hoje é:</p>
                    <div id="focus-task" 
                         contenteditable="true" 
                         class="text-base font-medium text-indigo-300 p-2 -ml-2 transition-all rounded-lg"
                         title="Clique para editar seu foco do dia">
                        [Carregando...]
                    </div>
                </div>
            </section>

            <!-- Seção: PokemonBlog.com -->
            <section>
                <div class="flex items-center gap-4 mb-3">
                    <i data-lucide="rss" class="text-orange-400 w-7 h-7 flex-shrink-0"></i>
                    <h2 class="text-2xl font-bold">PokemonBlog</h2>
                </div>
                <ul id="pokemonblog-feed" class="space-y-3 feed-container">
                    <!-- Feed será injetado aqui -->
                    <div class="loader"></div>
                </ul>
            </section>
            
        </div>
    </aside>

    <!-- NOVO: Barra de Progresso de Atualização -->
    <div id="refresh-progress-bar-container" class="fixed bottom-0 left-0 w-full h-1 bg-slate-700 z-50 overflow-hidden">
        <!-- A animação desta barra será controlada via JS -->
        <div id="refresh-progress-bar" class="h-1 bg-indigo-400" style="width: 100%; transform: scaleX(0); transform-origin: left;"></div>
    </div>


    <!-- CÓDIGO SCRIPT -->
    <script>
        // --- EMOJI E MAPA DE PALAVRAS-CHAVE ---
        const emojiMap = {
            'v-max': '⚡️',
            'gigantamax': '💥',
            'scarlet': '💜',
            'violet': '🧡',
            'dlc': '💿',
            'update': '⬆️',
            'event': '🎉',
            'battle': '⚔️',
            'contest': '🏆',
            'new': '✨',
            'tcg': '🃏',
            'anime': '📺',
            'unite': '🤝',
            'go': '📱',
            'legends': '📖',
            'sleep': '😴',
            'mystery gift': '🎁',
            'z-a': '💠',
            'review': '🤔',
            'guide': '🗺️'
        };

        /**
         * Retorna um emoji baseado no título da notícia.
         */
        function getEmojiForTitle(title) {
            for (const keyword in emojiMap) {
                if (title.includes(keyword)) {
                    return emojiMap[keyword];
                }
            }
            return '📰'; // Padrão
        }

        /**
         * ATUALIZADO: Formata uma string de data para um objeto { date, time }
         */
        function formatFeedDate(dateString) {
            const emptyResult = { date: null, time: null };
            if (!dateString) {
                return emptyResult; // Retorna vazio se não houver data
            }
            try {
                const date = new Date(dateString);
                // Verifica se a data é válida
                if (isNaN(date.getTime())) {
                    console.warn("Data de feed inválida:", dateString);
                    return emptyResult; // Data inválida
                }
                
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Mês é base 0
                const hour = String(date.getHours()).padStart(2, '0');
                const minute = String(date.getMinutes()).padStart(2, '0');
                
                return {
                    date: `${day}/${month}`,
                    time: `${hour}:${minute}`
                };
            } catch (error) {
                console.warn("Não foi possível formatar a data:", dateString, error);
                return emptyResult; // Retorna vazio em caso de erro
            }
        }


        // --- CONSTANTES E URLs ---
        const POKEMONBLOG_URL = "https://corsproxy.io/?https%3A%2F%2Fpokemonblog.com%2Ffeed%2F";
        const POKEMONDB_URL = "https://corsproxy.io/?https%3A%2F%2Fpokemondb.net%2Fnews%2Ffeed%2F";
        const POKEMANIACAL_URL = "https://corsproxy.io/?https%3A%2F%2Fpokemaniacal.com%2Ffeed%2F";
        
        const WEATHER_URL = "https://corsproxy.io/?https%3A%2F%2Fgoweather.herokuapp.com%2Fweather%2FAmericana";
        const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 Minutos
        const CLOCK_INTERVAL = 1000; // 1 segundo
        const PROGRESS_BAR_UPDATE_INTERVAL = 1000; // 1 segundo (para a barra de progresso)


        // --- ELEMENTOS DO DOM ---
        const clockEl = document.getElementById('clock');
        const dateEl = document.getElementById('date');
        const greetingEl = document.getElementById('greeting');
        const focusTaskEl = document.getElementById('focus-task');
        const weatherContentEl = document.getElementById('weather-content');
        const weatherLocationEl = document.getElementById('weather-location');
        
        const pokemonBlogFeedEl = document.getElementById('pokemonblog-feed');
        const pokemonDbFeedEl = document.getElementById('pokemondb-feed');
        const pokeManiacalFeedEl = document.getElementById('pokemaniacal-feed');

        const pokemonLoaderEl = document.getElementById('pokemon-loader');
        const pokemonImageEl = document.getElementById('pokemon-image');

        const progressBarEl = document.getElementById('refresh-progress-bar');

        // --- VARIÁVEIS DE ESTADO ---
        let lastRefreshTime = 0;


        // --- FUNÇÕES DE ATUALIZAÇÃO ---

        /**
         * Atualiza a barra de progresso de 5 minutos.
         */
        function updateProgressBar() {
            const now = Date.now();
            const elapsed = now - lastRefreshTime;
            let progress = (elapsed / REFRESH_INTERVAL);
            
            if (progress >= 1) {
                progress = 1;
            }
            
            progressBarEl.style.transform = `scaleX(${progress})`;
        }


        /**
         * Atualiza o relógio e a data.
         */
        let currentDateString = "";
        function updateClockAndDate() {
            const now = new Date();
            
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            clockEl.textContent = now.toLocaleTimeString('pt-BR', timeOptions);
            
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
            let newDateString = now.toLocaleDateString('pt-BR', dateOptions);
            
            if (newDateString !== currentDateString) {
                currentDateString = newDateString;
                dateEl.textContent = currentDateString.charAt(0).toUpperCase() + currentDateString.slice(1);
            }
        }

        /**
         * Define a saudação
         */
        function updateGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) {
                greetingEl.textContent = "Bom dia!";
            } else if (hour < 18) {
                greetingEl.textContent = "Boa tarde!";
            } else {
                greetingEl.textContent = "Boa noite!";
            }
        }
        
        /**
         * Carrega e salva a tarefa de foco
         */
        function setupFocusTask() {
            const savedFocus = localStorage.getItem('dailyFocusTask');
            focusTaskEl.textContent = savedFocus || '[Clique para definir seu foco]';
            focusTaskEl.addEventListener('blur', () => {
                localStorage.setItem('dailyFocusTask', focusTaskEl.textContent.trim());
            });
            focusTaskEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    focusTaskEl.blur();
                }
            });
        }

        /**
         * Mapeia a descrição do tempo para um ícone Lucide
         */
        function getWeatherIcon(description) {
            const desc = description.toLowerCase();
            if (desc.includes('sunny') || desc.includes('clear')) return 'sun';
            if (desc.includes('partly cloudy')) return 'cloud-sun';
            if (desc.includes('cloudy') || desc.includes('overcast')) return 'cloud';
            if (desc.includes('rain') || desc.includes('shower')) return 'cloud-rain';
            if (desc.includes('thunder')) return 'cloud-lightning';
            if (desc.includes('snow')) return 'cloud-snow';
            if (desc.includes('fog') || desc.includes('mist')) return 'cloud-fog';
            return 'sun'; // Padrão
        }

        /**
         * Busca e exibe o clima
         */
        async function fetchWeather() {
            try {
                const response = await fetch(WEATHER_URL);
                if (!response.ok) throw new Error('Erro na rede ao buscar clima');
                
                const data = await response.json();

                if (!data.temperature || !data.description) {
                    if (response.headers.get("content-type")?.includes("text/html")) {
                        throw new Error('Proxy (corsproxy.io) falhou ao buscar o clima.');
                    }
                    throw new Error('Formato de dados do clima inesperado.');
                }

                const weatherDesc = data.description;
                const tempC = data.temperature.replace('+', '').trim(); 
                const iconName = getWeatherIcon(weatherDesc);

                weatherContentEl.innerHTML = `
                    <div id="weather-icon">
                        <i data-lucide="${iconName}" class="w-20 h-20 text-indigo-400"></i>
                    </div>
                    <div>
                        <div class="text-5xl font-bold">${tempC}</div>
                        <div class="text-xl text-gray-300">${weatherDesc}</div>
                    </div>
                `;
                weatherLocationEl.textContent = `Americana, SP`;
                lucide.createIcons();

            } catch (error) {
                console.error("Erro ao buscar clima:", error);
                weatherContentEl.innerHTML = '<p class="text-red-400">Não foi possível carregar o clima.</p>';
            }
        }

        /**
         * Função genérica para buscar feeds RSS (XML)
         */
        async function fetchRssFeed(url, container, limit, feedName, hoverColor) {
            try {
                const response = await fetch(url); 
                
                if (response.status === 429) { 
                       throw new Error(`Proxy (corsproxy.io) está com limite de requisições. Tente mais tarde. (Feed: ${feedName})`);
                }
                if (!response.ok) throw new Error(`Erro na rede (proxy ${feedName}) - Status: ${response.status}`);
                
                const xmlString = await response.text(); 
                
                if (!xmlString) {
                    throw new Error(`Proxy retornou conteúdo vazio (provavelmente bloqueado: ${feedName}).`);
                }

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");
                
                const parserError = xmlDoc.querySelector("parsererror");
                if (parserError) {
                    console.error(`Erro ao parsear XML ${feedName}:`, parserError.textContent);
                    throw new Error(`Erro ao ler o feed XML (${feedName})`);
                }

                const items = Array.from(xmlDoc.querySelectorAll("item, entry")).slice(0, limit);
                
                if (items.length === 0 && !parserError) {
                    throw new Error(`Feed (${feedName}) vazio ou estrutura inesperada.`);
                }
                
                container.innerHTML = ''; // Limpa o loader
                
                items.forEach(item => {
                    const title = item.querySelector("title")?.textContent || 'Sem Título';
                    const link = (item.querySelector("link")?.textContent || item.querySelector("link")?.getAttribute('href')) || '#';
                    
                    const dateString = item.querySelector("pubDate")?.textContent || item.querySelector("published")?.textContent || item.querySelector("updated")?.textContent;
                    // --- ATUALIZADO: Agora é um objeto { date, time } ---
                    const dateTime = formatFeedDate(dateString);

                    if (link.includes('#comments')) return; 

                    const emoji = getEmojiForTitle(title.toLowerCase());

                    const li = document.createElement('li');
                    li.className = "border-b border-slate-700/50 pb-3 last:border-b-0";
                    
                    // --- ATUALIZADO: HTML para incluir o emoji e o contêiner de data/hora ---
                    li.innerHTML = `
                        <a href="${link}" target="_blank" rel="noopener noreferrer" 
                           class="text-sm text-gray-200 font-medium hover:text-${hoverColor}-400 transition-colors duration-200 flex items-center gap-2.5">
                            
                            <!-- Span para o emoji -->
                            <span class="text-lg" title="${emoji}">${emoji}</span> 
                            
                            <!-- Span para o título (flex-1 faz ele ocupar o espaço restante) -->
                            <span class="flex-1">${title}</span>

                            <!-- NOVO: Contêiner de Data/Hora (só aparece se a data for válida) -->
                            ${dateTime.date ? `
                                <div class="flex flex-col items-end flex-shrink-0 -space-y-0.5">
                                    <span class="text-xs text-slate-400 font-mono">${dateTime.date}</span>
                                    <span class="text-[0.7rem] text-slate-500 font-mono">${dateTime.time}</span>
                                </div>
                            ` : ''}
                        </a>
                    `;
                    container.appendChild(li);
                });

            } catch (error) {
                console.error(`Erro ao buscar notícias de ${feedName}:`, error);
                container.innerHTML = `<li class="text-red-400 p-2 text-sm">Não foi possível carregar as notícias. (${feedName} ou o proxy podem estar offline).</li>`;
            }
        }

        /**
         * ATUALIZADO: Busca um Pokémon aleatório, garantindo alta resolução.
         */
        async function fetchRandomPokemon() {
            try {
                // Mostrar loader e esconder imagem antiga
                pokemonLoaderEl.classList.remove('hidden');
                pokemonImageEl.classList.add('hidden');
                pokemonImageEl.classList.remove('opacity-100'); 

                // ID Aleatório (Gen 1-9, ID 1 a 1025)
                const randomId = Math.floor(Math.random() * 1025) + 1;
                
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${randomId}`);
                if (!response.ok) throw new Error('Erro na rede ao buscar Pokémon');

                const data = await response.json();

                // Lógica do Shiny (1% de chance)
                const isShiny = Math.random() < 0.01;
                
                const sprites = data.sprites.other;
                let imageUrl = null;
                
                // 1. Tenta pegar a imagem Shiny de ALTA RESOLUÇÃO
                if (isShiny) {
                    imageUrl = sprites['official-artwork']?.front_shiny || 
                               sprites.home?.front_shiny;
                }

                // 2. Se não for shiny (ou se a imagem shiny high-res não existir),
                //    tenta pegar a imagem Normal de ALTA RESOLUÇÃO
                if (!imageUrl) {
                    imageUrl = sprites['official-artwork']?.front_default || 
                               sprites.home?.front_default;
                }

                // 3. VERIFICAÇÃO DE QUALIDADE (NOVO)
                if (!imageUrl) {
                    console.log(`Pokémon ${data.name} (ID: ${randomId}) não tem imagem de alta resolução. Sorteando outro...`);
                    setTimeout(fetchRandomPokemon, 100); 
                    return; // Para a execução desta tentativa
                }

                // 4. Configura os handlers ANTES de definir o .src
                pokemonImageEl.onload = () => {
                    pokemonLoaderEl.classList.add('hidden');
                    pokemonImageEl.classList.remove('hidden');
                    pokemonImageEl.classList.add('opacity-100');
                };
                
                pokemonImageEl.onerror = () => {
                    console.warn(`Falha ao carregar a imagem: ${imageUrl}. Sorteando outro Pokémon...`);
                    pokemonImageEl.onerror = null; // Limpa o handler para evitar loops
                    setTimeout(fetchRandomPokemon, 100); // Adiciona um pequeno atraso
                };

                // 5. Define a fonte da imagem (agora com handlers prontos)
                pokemonImageEl.src = imageUrl;
                pokemonImageEl.alt = `Imagem de ${data.name} ${isShiny ? '(shiny)' : ''}`;

            } catch (error) {
                console.error("Erro ao buscar Pokémon (catch):", error);
                setTimeout(fetchRandomPokemon, 1000);
            }
        }
        
        /**
         * Função principal para buscar todos os dados
         */
        function fetchAllData() {
            // Reseta o timer da barra de progresso
            lastRefreshTime = Date.now();
            
            // --- Lógica para resetar a barra visualmente ---
            progressBarEl.style.transition = 'none';
            progressBarEl.style.transform = 'scaleX(0)';
            progressBarEl.offsetHeight; 
            progressBarEl.style.transition = `transform ${PROGRESS_BAR_UPDATE_INTERVAL}ms linear`;
            // --- Fim da lógica de reset ---

            // Busca os dados
            fetchWeather();
            fetchRssFeed(POKEMONBLOG_URL, pokemonBlogFeedEl, 8, "PokemonBlog", "orange");
            fetchRandomPokemon();
        }

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            updateClockAndDate();
            updateGreeting();
            setupFocusTask();
            
            lastRefreshTime = Date.now();
            progressBarEl.style.transition = `transform ${PROGRESS_BAR_UPDATE_INTERVAL}ms linear`;

            setTimeout(fetchAllData, 100); 

            lucide.createIcons();
            
            setInterval(updateClockAndDate, CLOCK_INTERVAL); 
            setInterval(fetchAllData, REFRESH_INTERVAL);
            setInterval(updateProgressBar, PROGRESS_BAR_UPDATE_INTERVAL);
        });

    </script>
</body>
</html>

